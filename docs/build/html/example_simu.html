<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

      <title>🔖 CEM Notebook Example - Simulated Linear Dataset</title>
    
          <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="_static/theme-vendors.js"></script> -->
      <script src="_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="next" title="🔖 CEM Notebook Example - Lalonde Dataset" href="example_real.html" />
  <link rel="prev" title="Example" href="example.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="index.html" class="home-link">
    
      <span class="site-name">CEM-LinearInf</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="index.html#cem-linearinf-s-documentation"
         class="nav-link ">
         Catalogue
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#functions"
         class="nav-link ">
         ✏️ functions
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#contents"
         class="nav-link ">
         📖 contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#reference"
         class="nav-link ">
         ⭐️ reference
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="index.html#cem-linearinf-s-documentation"
         class="nav-link ">
         Catalogue
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#functions"
         class="nav-link ">
         ✏️ functions
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#contents"
         class="nav-link ">
         📖 contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#reference"
         class="nav-link ">
         ⭐️ reference
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#cem-linearinf-s-documentation">Catalogue</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#functions">✏️ functions</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#contents">📖 contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="usage.html" class="reference internal ">Usage</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="tutorial.html" class="reference internal ">Tutorial</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="example.html" class="reference internal ">Example</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="api.html" class="reference internal ">API Reference</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#reference">⭐️ reference</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
      <li><a href="example.html">Example</a> &raquo;</li>
    
    <li>🔖 CEM Notebook Example - Simulated Linear Dataset</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="example.html"
       title="previous chapter">← Example</a>
  </li>
  <li class="next">
    <a href="example_real.html"
       title="next chapter">🔖 CEM Notebook Example - Lalonde Dataset →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="cem-notebook-example-simulated-linear-dataset">
<h1>🔖 CEM Notebook Example - Simulated Linear Dataset<a class="headerlink" href="#cem-notebook-example-simulated-linear-dataset" title="Permalink to this heading">¶</a></h1>
<p>Here we provide a notebook example illustrating the usage of the CEM package with simulated dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">CEM.balance</span> <span class="kn">import</span> <span class="n">balance</span>
<span class="kn">from</span> <span class="nn">CEM.cem</span> <span class="kn">import</span> <span class="n">cem</span>
<span class="kn">from</span> <span class="nn">CEM.data_generation</span> <span class="kn">import</span> <span class="n">data_generation</span>
<span class="kn">from</span> <span class="nn">CEM.inference</span> <span class="kn">import</span> <span class="n">inference</span>
<span class="kn">from</span> <span class="nn">CEM.sensitivity_analysis</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<section id="data-preperation">
<h2>1. Data preperation<a class="headerlink" href="#data-preperation" title="Permalink to this heading">¶</a></h2>
<p>The first step to prepare our dataset, and we can generate a simulated dataset with <code class="docutils literal notranslate"><span class="pre">data_generation</span></code> function, in which the result variable <span class="math notranslate nohighlight">\(Y\)</span> is linearly dependent with control variables <span class="math notranslate nohighlight">\(X\)</span> and treatment variable <span class="math notranslate nohighlight">\(T\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">data_generation</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="c1"># sample size</span>
                    <span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>   <span class="c1"># P(T=1)</span>
                    <span class="n">att</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>   <span class="c1"># True average treatment effect on treated</span>
                    <span class="n">x_cont</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="c1"># Generate 6 continuous variables X following the normal distribution N(0, 1).</span>
                    <span class="n">x_cate</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1"># Generate 3 catigorical variables X with 2, 4, 4 categories respectively.</span>
                    <span class="n">con_x</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)]</span> <span class="c1"># X1, X2, X3, X7, X9 are confounders and</span>
                    <span class="p">)</span>                                                   <span class="c1"># their effect on T are 3, -2, 1, 2.5, 1.5 resectively.</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="coarsened-exact-matching-cem">
<h2>2. Coarsened Exact Matching (CEM)<a class="headerlink" href="#coarsened-exact-matching-cem" title="Permalink to this heading">¶</a></h2>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">cem</span></code> , giving it your dataframe, column names of confounders, continuous confounders, result variable <span class="math notranslate nohighlight">\(Y\)</span> and treatment variable <span class="math notranslate nohighlight">\(T\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">confounder_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X1&#39;</span><span class="p">,</span><span class="s1">&#39;X2&#39;</span><span class="p">,</span><span class="s1">&#39;X3&#39;</span><span class="p">,</span><span class="s1">&#39;X7&#39;</span><span class="p">,</span> <span class="s1">&#39;X9&#39;</span><span class="p">]</span>
<span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X1&#39;</span><span class="p">,</span><span class="s1">&#39;X2&#39;</span><span class="p">,</span><span class="s1">&#39;X3&#39;</span><span class="p">]</span>
<span class="n">my_cem</span> <span class="o">=</span> <span class="n">cem</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span> <span class="c1"># dataframe to be matched</span>
            <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">confounder_cols</span><span class="p">,</span> <span class="c1"># list of confounders&#39; column names</span>
            <span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="c1"># list of continuous confounders&#39; column names</span>
            <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
            <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span> <span class="c1"># column name of treatment variable</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>The summary of the simulated dataframe is as follows.</p>
<p>Before matching the <strong>estimated ATT</strong> (Average Treatment Effect on Treated) is 1.0085, which is far from the <strong>true ATT</strong> 3.0.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Descriptive Statistics of the dataframe:

                X1           X2           X3           X4           X5  \
count  10,000.0000  10,000.0000  10,000.0000  10,000.0000  10,000.0000
mean       -0.0160       0.0213      -0.0013       0.0001      -0.0144
std         0.9963       1.0065       0.9986       0.9955       0.9841
min        -3.5670      -4.2668      -4.7132      -4.0806      -3.4952
25%        -0.6865      -0.6595      -0.6691      -0.6720      -0.6779
50%        -0.0231       0.0113      -0.0048      -0.0038      -0.0129
75%         0.6568       0.7026       0.6661       0.6730       0.6519
max         3.6061       3.7632       4.1706       3.9502       3.7476

                X6           X7           X8           X9            T  \
count  10,000.0000  10,000.0000  10,000.0000  10,000.0000  10,000.0000
mean       -0.0016       0.4954       1.5062       1.4953       0.1533
std         1.0056       0.5000       1.1230       1.1172       0.3603
min        -3.8068       0.0000       0.0000       0.0000       0.0000
25%        -0.6853       0.0000       1.0000       0.0000       0.0000
50%        -0.0034       0.0000       1.0000       2.0000       0.0000
75%         0.6783       1.0000       3.0000       2.0000       0.0000
max         4.5216       1.0000       3.0000       3.0000       1.0000

                Y
count  10,000.0000
mean        6.4324
std         9.5579
min       -29.9051
25%        -0.0168
50%         6.3347
75%        12.9615
max        43.8527

Control group vs. Experimental group

n_samples    mean_Y
0       8467  6.277839
1       1533  7.286350

T-test of Experimental group Y and Control group Y

att estimate (p-value): 1.0085(0.0001)
The difference between Experimental group Y and Control group Y is significant, and the difference is 1.0085.
</pre></div>
</div>
<p>Then we can try matching your dataset using <code class="docutils literal notranslate"><span class="pre">match</span></code> function with default parameters.
After the default coarsened exact matching, 82.84% treated samples are matched.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

    all  matched  propotion
0  8467     3338     0.3942
1  1533     1270     0.8284
</pre></div>
</div>
</section>
<section id="balance-checking">
<h2>3. Balance Checking<a class="headerlink" href="#balance-checking" title="Permalink to this heading">¶</a></h2>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">balance</span></code> instance, giving it your matched dataframe, original dataframe, column names of confounders, continuous confounders, result variable <span class="math notranslate nohighlight">\(Y\)</span> and treatment variable <span class="math notranslate nohighlight">\(T\)</span>.</p>
<p>Let’s check the L1 imbalance score after CEM with default coarsen parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">df_match</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="c1"># matched dataframe</span>
                    <span class="n">df_all</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="c1"># original dataframe</span>
                    <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">,</span> <span class="c1"># list of column names of confounders</span>
                    <span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="c1"># list of column names of continuous confounders</span>
                    <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
                    <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span> <span class="c1"># column name of treatment variable</span>

<span class="n">l1_before</span><span class="p">,</span> <span class="n">l1_after</span> <span class="o">=</span> <span class="n">my_balance</span><span class="o">.</span><span class="n">balance_assessing</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;L1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>L1 imbalance score before matching: 0.6316

L1 imbalance score after matching: 0.2895
</pre></div>
</div>
<p>Moreover, we can customize our coarsen schema to optimize our matching result.</p>
<p><strong>Method 1:</strong>
You can input a schema dictionary indicating how to coarsen each continuous confounders <span class="math notranslate nohighlight">\(X\)</span> if you have a thorough understanding on your dataset.</p>
<p>The following cutting method can be chosen.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cut</span></code>: Bin values into discrete intervals with the same length.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qcut</span></code>: Discretize variable into equal-sized buckets based on rank or based on sample quantiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struges</span></code>: Bin values into discrete intervals with the same length k according to the Sturges’ rule.</p></li>
</ul>
<p><strong>Method 2:</strong>
You can also use the <code class="docutils literal notranslate"><span class="pre">tunning_schema</span></code> function to help you tune the coarsen schema automatically.
The matched result with a suitable coarsen schema will have smaller L1 imbalance score and more matched samples.</p>
<p>Here we show the example of <code class="docutils literal notranslate"><span class="pre">tunning_schema</span></code>. Comparing with default coarsen schema, the L1 imbalance score after matching with tuned schema decreases from 0.2895 to 0.2591.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">tunning_schema</span><span class="p">(</span><span class="n">step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">my_cem</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">)</span>
<span class="n">my_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">cont_confounder_cols</span><span class="p">)</span>
<span class="n">my_balance</span><span class="o">.</span><span class="n">balance_assessing</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

    all  matched  propotion
0  8467     5763     0.6806
1  1533     1431     0.9335

L1 imbalance score before matching: 0.434

L1 imbalance score after matching: 0.2591

-------------------------
SMD Result

Balance measures

        Treated Mean  Control Mean     SMD Variance Ratio SMD.Threshold(&lt;0.1)  \
    X1        0.1755        0.0924  0.0956         0.9329            Balanced
    X2       -0.1462       -0.1407 -0.0062         1.0103            Balanced
    X3        0.1375        0.1331  0.0049         0.9924            Balanced
    X7        0.5304        0.5304  0.0000              .            Balanced
    X9        1.6660        1.6660 -0.0000              .            Balanced

    Var.Threshold(&lt;2)
    X1          Balanced
    X2          Balanced
    X3          Balanced
    X7                 .
    X9                 .

    -------------------------
    Balance tally for SMD

                        count
    SMD.Threshold(&lt;0.1)
    Balanced                 5

    ------------------------------
    Variable with the max SMD:

        SMD SMD.Threshold(&lt;0.1)
    X1  0.0956            Balanced

    ------------------------------------
    Balance tally for Variance ratio

                       count
    Var.Threshold(&lt;2)
    Balanced               3

    -----------------------------------------
    Variable with the max variance ratio:

    Variance Ratio Var.Threshold(&lt;2)
    X2         1.0103          Balanced

    -----------------------------------------
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/smd.png"><img alt="smd_result" class="align-center" src="_images/smd.png" style="width: 4.63529in; height: 2.97222in;" /></a>
<p>KS Result</p>
<a class="reference internal image-reference" href="_images/ks.png"><img alt="ks_result" class="align-center" src="_images/ks.png" style="width: 4.63529in; height: 2.97222in;" /></a>
<p>Density Plot</p>
<a class="reference internal image-reference" href="_images/den1.png"><img alt="density_result" class="align-center" src="_images/den1.png" style="width: 4.63529in; height: 2.97222in;" /></a>
<a class="reference internal image-reference" href="_images/den2.png"><img alt="density_result" class="align-center" src="_images/den2.png" style="width: 4.63529in; height: 2.97222in;" /></a>
<p>ECDF Plot</p>
<a class="reference internal image-reference" href="_images/ecdf.png"><img alt="ecdf_result" class="align-center" src="_images/ecdf.png" style="width: 4.63529in; height: 4.97222in;" /></a>
</section>
<section id="treatment-effect-inference">
<h2>4. Treatment Effect Inference<a class="headerlink" href="#treatment-effect-inference" title="Permalink to this heading">¶</a></h2>
<p>After conducting the coarsened exact matching and imbalance checking, we can estimate the <strong>average treatment effect ATT</strong> and <strong>heterogeneous treatment effect HTE</strong> with statistical inference methods.</p>
<ul class="simple">
<li><p>Ordinal least square linear regression method <code class="docutils literal notranslate"><span class="pre">linear_att</span></code> and weighted least square linear regression method <code class="docutils literal notranslate"><span class="pre">weighted_linear_att</span></code> are provided for the ATT estimation.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[Y = \hat{\theta}T + \hat{\beta}X + ϵ, \widehat{ATT} = \hat{\theta}\]</div>
<ul class="simple">
<li><p>Linear double machine learning method (Chernozhukov et al. 2017) <code class="docutils literal notranslate"><span class="pre">linear_dml_hte</span></code> is provided for the HTE estimation.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}Y^{\bot X} = Y - \hat{\beta_{1}}X\\T^{\bot X} = T - \hat{\beta_{2}}X\\Y_i^{\bot X} = \widehat{\theta(X_i)}T^{\bot X} + ϵ\\\widehat{HTE} = \widehat{\theta(X_i)}\\\widehat{CATE} = E{\widehat{\theta(X_i)}}\end{aligned}\end{align} \]</div>
<p><strong>Reference</strong></p>
<ul class="simple">
<li><p>Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W., &amp; Robins, J. (2017). Double/debiased machine learning for treatment and causal parameters.</p></li>
</ul>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">inference</span></code> instance, giving it your matched dataframe,  column names of result variable <span class="math notranslate nohighlight">\(**Y**\)</span>, treatment variable <span class="math notranslate nohighlight">\(**T**\)</span>, control variables <span class="math notranslate nohighlight">\(**X**\)</span>, and confounders.</p>
<p>With the weighted linear regression method and linear double machine learning method, the estimated ATT and CATE are 2.8786, 3.0653 respectively, which are much better than 1.0085.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_inf</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="c1"># matched dataframe</span>
                <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
                <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="c1"># column name of treatment variable</span>
                <span class="n">col_x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X4&#39;</span><span class="p">,</span> <span class="s1">&#39;X5&#39;</span><span class="p">,</span> <span class="s1">&#39;X6&#39;</span><span class="p">,</span> <span class="s1">&#39;X8&#39;</span><span class="p">],</span> <span class="c1"># list of column names of control variables, please be noted that confounders should not be included in this list</span>
                <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">)</span> <span class="c1"># list of column names of confounders</span>

<span class="n">att</span> <span class="o">=</span> <span class="n">my_inf</span><span class="o">.</span><span class="n">weighted_linear_att</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;att: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">att</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">cate</span><span class="p">,</span> <span class="n">hte</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">my_inf</span><span class="o">.</span><span class="n">linear_dml_hte</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cate: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cate</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">, r2:</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                            WLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.704
Model:                            WLS   Adj. R-squared:                  0.704
Method:                 Least Squares   F-statistic:                     3420.
Date:                Fri, 21 Jul 2023   Prob (F-statistic):               0.00
Time:                        10:55:56   Log-Likelihood:                -22394.
No. Observations:                7194   AIC:                         4.480e+04
Df Residuals:                    7188   BIC:                         4.484e+04
Df Model:                           5
Covariance Type:            nonrobust
==============================================================================
                coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -2.5359      0.102    -24.891      0.000      -2.736      -2.336
T              2.8786      0.146     19.774      0.000       2.593       3.164
X4            -2.6487      0.059    -45.124      0.000      -2.764      -2.534
X5             3.6880      0.059     62.155      0.000       3.572       3.804
X6             3.1113      0.058     53.891      0.000       2.998       3.225
X8             4.7185      0.052     90.623      0.000       4.616       4.821
==============================================================================
Omnibus:                      481.185   Durbin-Watson:                   1.976
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1254.094
Skew:                          -0.383   Prob(JB):                    4.75e-273
Kurtosis:                       4.896   Cond. No.                         5.36
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

att: 2.8786
cate: 3.0594, r2:0.0007
</pre></div>
</div>
</section>
<section id="sensitivity-analysis">
<h2>5. Sensitivity Analysis<a class="headerlink" href="#sensitivity-analysis" title="Permalink to this heading">¶</a></h2>
<p>When we conduct causal inference to the observational data, the most important assumption is that there is no unobserved confounding.
Therefore, after finishing the treatment effect estimation, investigators are advised to examine how strong the effect of unobserved confounders should be to erase the treatment effect estimated.</p>
</section>
<section id="omitted-variable-bias-based-sensitivity-analysis">
<h2>5.1 Omitted variable bias based sensitivity analysis<a class="headerlink" href="#omitted-variable-bias-based-sensitivity-analysis" title="Permalink to this heading">¶</a></h2>
<p>In the following example, we choose <span class="math notranslate nohighlight">\(X2\)</span> as our benchmark variable. The analysis result gives us the following informations:</p>
<ul class="simple">
<li><p><strong>Robustness Value (RV)</strong>:</p></li>
</ul>
<p>It provides a convenient reference point to assess the overall robustness of a coefficient to unobserved confounders. If the confounder’s association to the treatment <span class="math notranslate nohighlight">\(R_{Y\sim Z|T, X}^2\)</span> and to
the outcome <span class="math notranslate nohighlight">\(R_{Z\sim T|X}^2\)</span> are both assumed to be less than the <span class="math notranslate nohighlight">\(RV\)</span>, then such confounders cannot “explain away” the observed effect.</p>
<ul class="simple">
<li><p><strong>Contour Line</strong>:</p></li>
</ul>
<p>The points on the same contour line has the same adjusted estimated ATT. The contour line helps us to know the value of the adjusted estimated <span class="math notranslate nohighlight">\(ATT\)</span> when <span class="math notranslate nohighlight">\(R_{Y\sim Z|T, X}^2 = a\)</span> and <span class="math notranslate nohighlight">\(R_{Z\sim T|X}^2 = b\)</span>.</p>
<ul class="simple">
<li><p><strong>Bound the strength of the hidden confounder using observed covariate</strong>:</p></li>
</ul>
<p>We can choose an observed confounder <span class="math notranslate nohighlight">\(X_j\)</span> as a benchmark, and check the adjusted estimated <span class="math notranslate nohighlight">\(ATT\)</span> when</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\frac{R_{Y\sim Z|T, X_{-j}}^2}{R_{Y\sim X_j|T, X_{-j}}^2} = K_Y\\\frac{R_{T\sim Z|X_{-j}}^2}{R_{T\sim X_j|X_{-j}}^2} = K_T\end{aligned}\end{align} \]</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">[[</span><span class="n">my_cem</span><span class="o">.</span><span class="n">col_t</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;X</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">[</span><span class="n">my_cem</span><span class="o">.</span><span class="n">col_y</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">my_ovb</span> <span class="o">=</span> <span class="n">ovb</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">bench_variable</span><span class="o">=</span><span class="s1">&#39;X1&#39;</span><span class="p">,</span> <span class="n">k_t</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">k_y</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>  <span class="n">measure</span> <span class="o">=</span> <span class="s1">&#39;att&#39;</span><span class="p">)</span>
<span class="n">my_ovb</span><span class="o">.</span><span class="n">plot_result</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/ovb.png"><img alt="smd_result" class="align-center" src="_images/ovb.png" style="width: 3.03529in; height: 2.97222in;" /></a>
</section>
<section id="wilcoxon-s-signed-rank-test-based-sensitivity-analysis">
<h2>5.2 Wilcoxon’s signed rank test based sensitivity analysis<a class="headerlink" href="#wilcoxon-s-signed-rank-test-based-sensitivity-analysis" title="Permalink to this heading">¶</a></h2>
<p>Wilcoxon’s signed rank test based sensitivity analysis is suitable for 1-1 matched dataset, therefore 1-1 matching needs to be conducted firstly. You can implement it simply by setting <code class="docutils literal notranslate"><span class="pre">k2k_ratio</span> <span class="pre">=</span> <span class="pre">1</span></code>, and here we choose the propensity score to measure the similarity by setting <code class="docutils literal notranslate"><span class="pre">dist</span> <span class="pre">=</span> <span class="pre">'psm'</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem_k2k</span> <span class="o">=</span> <span class="n">cem</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">confounder_cols</span><span class="p">,</span> <span class="n">cont_confounder_cols</span><span class="p">)</span>
<span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k2k_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;psm&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

    all  matched  propotion
0  8467     1270     0.1500
1  1533     1270     0.8284
</pre></div>
</div>
<p>The <cite>wilcoxon</cite> class function can give you a result table, which shows you the p-value intervals under each <span class="math notranslate nohighlight">\(\Gamma\)</span>.</p>
<p>In the following example, when <span class="math notranslate nohighlight">\(\Gamma = 4.25\)</span>, the upper bound of the p-value’s interval is greater than 0.05, which means that in this situation, we don’t have 95% confidence to reject the null hypothesis that the treatment is randomly assigned. In other words, when <span class="math notranslate nohighlight">\(\Gamma = 4.25\)</span> the estimated ATT will be explained away by unovserved confounders.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_sen</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">pair</span><span class="p">)</span>
<span class="n">wilcoxon_df</span> <span class="o">=</span> <span class="n">my_sen</span><span class="o">.</span><span class="n">result</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.25</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    lower_p  upper_p
gamma
1.00       0.0   0.0000
2.00       0.0   0.0000
3.00       0.0   0.0000
4.00       0.0   0.0112
4.25       0.0   0.0575
5.00       0.0   0.6223
The estimated ATT result is not reliable if there exists an unobservable confounder which makes the magnitude of probability
that a single subject will be interfered with is 4.25 times higher than that of the other subject.
</pre></div>
</div>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="example.html"
       title="previous chapter">← Example</a>
  </li>
  <li class="next">
    <a href="example_real.html"
       title="next chapter">🔖 CEM Notebook Example - Lalonde Dataset →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2023, WenyiWU.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 6.2.1 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>