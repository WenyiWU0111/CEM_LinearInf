<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

      <title>üîñ CEM Notebook Example - Lalonde Dataset</title>
    
          <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="_static/theme-vendors.js"></script> -->
      <script src="_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="next" title="API Reference" href="api.html" />
  <link rel="prev" title="üîñ CEM Notebook Example - Simulated Linear Dataset" href="example_simu.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="index.html" class="home-link">
    
      <span class="site-name">CEM-LinearInf</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="index.html#cem-linearinf-s-documentation"
         class="nav-link ">
         Catalogue
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#functions"
         class="nav-link ">
         ‚úèÔ∏è functions
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#contents"
         class="nav-link ">
         üìñ contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#reference"
         class="nav-link ">
         ‚≠êÔ∏è reference
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="index.html#cem-linearinf-s-documentation"
         class="nav-link ">
         Catalogue
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#functions"
         class="nav-link ">
         ‚úèÔ∏è functions
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#contents"
         class="nav-link ">
         üìñ contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#reference"
         class="nav-link ">
         ‚≠êÔ∏è reference
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#cem-linearinf-s-documentation">Catalogue</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#functions">‚úèÔ∏è functions</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#contents">üìñ contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="usage.html" class="reference internal ">Usage</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="tutorial.html" class="reference internal ">Tutorial</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="example.html" class="reference internal ">Example</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="api.html" class="reference internal ">API Reference</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#reference">‚≠êÔ∏è reference</a></span>
      </p>
      <ul class="">
        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
      <li><a href="example.html">Example</a> &raquo;</li>
    
    <li>üîñ CEM Notebook Example - Lalonde Dataset</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="example_simu.html"
       title="previous chapter">‚Üê üîñ CEM Notebook Example - Simulated Linear Dataset</a>
  </li>
  <li class="next">
    <a href="api.html"
       title="next chapter">API Reference ‚Üí</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="cem-notebook-example-lalonde-dataset">
<h1>üîñ CEM Notebook Example - Lalonde Dataset<a class="headerlink" href="#cem-notebook-example-lalonde-dataset" title="Permalink to this heading">¬∂</a></h1>
<p>Here we provide a notebook example illustrating the usage of the CEM package with the Lalonde dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">CEM.balance</span> <span class="kn">import</span> <span class="n">balance</span>
<span class="kn">from</span> <span class="nn">CEM.cem</span> <span class="kn">import</span> <span class="n">cem</span>
<span class="kn">from</span> <span class="nn">CEM.data_generation</span> <span class="kn">import</span> <span class="n">data_generation</span>
<span class="kn">from</span> <span class="nn">CEM.inference</span> <span class="kn">import</span> <span class="n">inference</span>
<span class="kn">from</span> <span class="nn">CEM.sensitivity_analysis</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<section id="data-preperation">
<h2>1. Data preperation<a class="headerlink" href="#data-preperation" title="Permalink to this heading">¬∂</a></h2>
<p>The first step to prepare our dataset, and we use the Lalonde dataset here (Lalonde, R. 1986).</p>
<p>The study looked at the effectiveness of a job training program (the treatment) on the real earnings of an individual, a couple years after completion of the program.</p>
<p>Lalonde dataset is a data frame with 614 observations, examining the impact of a job training program (referred to as the treatment) on the actual earnings of an individual.
There are 185 treated and 429 control subjects, and 10 variables. The treatment assignment indicator is the first variable of the data frame: treatment (1 = treated; 0 = control). The next 7 columns are the covariates:</p>
<ul class="simple">
<li><p><strong>age</strong>: continuous, measured in years;</p></li>
<li><p><strong>education</strong>: continuous, measured in years;</p></li>
<li><p><strong>black</strong>: categorical, indicating race (1 if black, 0 otherwise);</p></li>
<li><p><strong>hispanic</strong>: categorical, indicating race (1 if Hispanic, 0 otherwise);</p></li>
<li><p><strong>married</strong>: categorical, indicating marital status (1 if married, 0 otherwise);</p></li>
<li><p><strong>nodegree</strong>: categorical, indicating high school diploma (1 if no degree, 0 otherwise);</p></li>
<li><p><strong>re74</strong>: continuous, real earnings in 1974;</p></li>
<li><p><strong>re75</strong>: continuous, real earnings in 1975.</p></li>
</ul>
<p>The last variable of the data frame is <strong>re78</strong>, the real the earnings in 1978.</p>
<p><strong>Reference</strong></p>
<ul class="simple">
<li><p>Dehejia, R., and Wahba, S. (1999), ‚ÄúCausal Effects in Nonexperimental Studies: Reevaluating the Evaluation of Training Programs,‚Äù Journal of the American Statistical Association, 94, 1053-1062.</p></li>
<li><p>Lalonde, R. (1986), ‚ÄúEvaluating the Econometric Evaluations of Training Programs,‚Äù American Economic Review, 76, 604-620.</p></li>
<li><p><a class="reference external" href="https://search.r-project.org/CRAN/refmans/designmatch/html/lalonde.html">https://search.r-project.org/CRAN/refmans/designmatch/html/lalonde.html</a></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/content/lalonde.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="coarsened-exact-matching-cem">
<h2>2. Coarsened Exact Matching (CEM)<a class="headerlink" href="#coarsened-exact-matching-cem" title="Permalink to this heading">¬∂</a></h2>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">cem</span></code> , giving it your dataframe, column names of confounders, continuous confounders, result variable <span class="math notranslate nohighlight">\(re78\)</span> and treatment variable <span class="math notranslate nohighlight">\(treat\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">confounder_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;hispan&#39;</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">,</span> <span class="s1">&#39;nodegree&#39;</span><span class="p">]</span>
<span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;educ&#39;</span><span class="p">]</span>
<span class="n">my_cem</span> <span class="o">=</span> <span class="n">cem</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span> <span class="c1"># dataframe to be matched</span>
            <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">confounder_cols</span><span class="p">,</span> <span class="c1"># list of confounders&#39; column names</span>
            <span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="c1"># list of continuous confounders&#39; column names</span>
            <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;re78&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
            <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;treat&#39;</span> <span class="c1"># column name of treatment variable</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>The summary of the simulated dataframe is as follows.</p>
<p>Before matching the <strong>estimated ATT</strong> (Average Treatment Effect on Treated) is 1.0085, which is far from the <strong>true ATT</strong> 3.0.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Descriptive Statistics of the dataframe:

        treat       age      educ     black    hispan   married  nodegree  \
count  614.0000  614.0000  614.0000  614.0000  614.0000  614.0000  614.0000
mean     0.3013   27.3632   10.2687    0.3958    0.1173    0.4153    0.6303
std      0.4592    9.8812    2.6283    0.4894    0.3220    0.4932    0.4831
min      0.0000   16.0000    0.0000    0.0000    0.0000    0.0000    0.0000
25%      0.0000   20.0000    9.0000    0.0000    0.0000    0.0000    0.0000
50%      0.0000   25.0000   11.0000    0.0000    0.0000    0.0000    1.0000
75%      1.0000   32.0000   12.0000    1.0000    0.0000    1.0000    1.0000
max      1.0000   55.0000   18.0000    1.0000    1.0000    1.0000    1.0000

            re74         re75         re78
count     614.0000     614.0000     614.0000
mean    4,557.5466   2,184.9382   6,792.8345
std     6,477.9645   3,295.6790   7,470.7308
min         0.0000       0.0000       0.0000
25%         0.0000       0.0000     238.2834
50%     1,042.3300     601.5484   4,759.0185
75%     7,888.4982   3,248.9875  10,893.5925
max    35,040.0700  25,142.2400  60,307.9300

Control group vs. Experimental group

n_samples       mean_Y
0        429  6984.169742
1        185  6349.143530

T-test of Experimental group Y and Control group Y

att estimate (p-value): -635.0262(0.3342)
The difference between Experimental group Y and Control group Y is not significant.
</pre></div>
</div>
<p>Then we can try matching your dataset using <code class="docutils literal notranslate"><span class="pre">match</span></code> function with default parameters.
After the default coarsened exact matching, 63.24% treated samples are matched.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

   all  matched  propotion
0  429      154     0.3590
1  185      117     0.6324
</pre></div>
</div>
</section>
<section id="balance-checking">
<h2>3. Balance Checking<a class="headerlink" href="#balance-checking" title="Permalink to this heading">¬∂</a></h2>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">balance</span></code> instance, giving it your matched dataframe, original dataframe, column names of confounders, continuous confounders, result variable <span class="math notranslate nohighlight">\(re78\)</span> and treatment variable <span class="math notranslate nohighlight">\(treat\)</span>.</p>
<p>Let‚Äôs check the L1 imbalance score after CEM with default coarsen parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">df_match</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="c1"># matched dataframe</span>
                 <span class="n">df_all</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="c1"># original dataframe</span>
                 <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">,</span> <span class="c1"># list of column names of confounders</span>
                 <span class="n">cont_confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="c1"># list of column names of continuous confounders</span>
                 <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;re78&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
                 <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;treat&#39;</span><span class="p">)</span> <span class="c1"># column name of treatment variable</span>

<span class="n">l1_before</span><span class="p">,</span> <span class="n">l1_after</span> <span class="o">=</span> <span class="n">my_balance</span><span class="o">.</span><span class="n">balance_assessing</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;L1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>L1 imbalance score before matching: 0.7775

L1 imbalance score after matching: 0.4846
</pre></div>
</div>
<p>Moreover, we can customize our coarsen schema to optimize our matching result.</p>
<p><strong>Method 1:</strong>
You can input a schema dictionary indicating how to coarsen each continuous confounders <span class="math notranslate nohighlight">\(X\)</span> if you have a thorough understanding on your dataset.</p>
<p>The following cutting method can be chosen.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cut</span></code>: Bin values into discrete intervals with the same length.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qcut</span></code>: Discretize variable into equal-sized buckets based on rank or based on sample quantiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struges</span></code>: Bin values into discrete intervals with the same length k according to the Sturges‚Äô rule.</p></li>
</ul>
<p><strong>Method 2:</strong>
You can also use the <code class="docutils literal notranslate"><span class="pre">tunning_schema</span></code> function to help you tune the coarsen schema automatically.
The matched result with a suitable coarsen schema will have smaller L1 imbalance score and more matched samples.</p>
<p>Here we show the example of <code class="docutils literal notranslate"><span class="pre">tunning_schema</span></code>. Comparing with default coarsen schema, the L1 imbalance score after matching with tuned schema decreases from 0.4846 to 0.4372.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">tunning_schema</span><span class="p">(</span><span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">my_cem</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">)</span>
<span class="n">my_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">,</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;re78&#39;</span><span class="p">,</span> <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;treat&#39;</span><span class="p">)</span>
<span class="n">my_balance</span><span class="o">.</span><span class="n">balance_assessing</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

all  matched  propotion
0  429      146     0.3403
1  185      114     0.6162

L1 imbalance score before matching: 0.7619

L1 imbalance score after matching: 0.4372

-------------------------

SMD Result

Balance measures

        Treated Mean  Control Mean     SMD Variance Ratio  \
age            24.8333       25.1079 -0.0323         0.7514
educ           10.6579       10.6566  0.0007         0.8947
black           0.8509        0.8509 -0.0000              .
hispan          0.0263        0.0263  0.0000              .
married         0.0965        0.0965  0.0000              .
nodegree        0.6053        0.6053 -0.0000              .


        SMD.Threshold(&lt;0.1) Var.Threshold(&lt;2)
age                 Balanced          Balanced
educ                Balanced          Balanced
black               Balanced                 .
hispan              Balanced                 .
married             Balanced                 .
nodegree            Balanced                 .

-------------------------
Balance tally for SMD

                    count
SMD.Threshold(&lt;0.1)
Balanced                 6

------------------------------
Variable with the max SMD:

        SMD SMD.Threshold(&lt;0.1)
educ  0.0007            Balanced

------------------------------------
Balance tally for Variance ratio

                count
Var.Threshold(&lt;2)
Balanced               2

-----------------------------------------
Variable with the max variance ratio:

    Variance Ratio Var.Threshold(&lt;2)
educ         0.8947          Balanced

-----------------------------------------
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/smd_real.png"><img alt="smd_result" class="align-center" src="_images/smd_real.png" style="width: 4.03529in; height: 2.97222in;" /></a>
<p>KS Result</p>
<a class="reference internal image-reference" href="_images/ks_real.png"><img alt="ks_result" class="align-center" src="_images/ks_real.png" style="width: 4.03529in; height: 2.97222in;" /></a>
<p>Density Plot</p>
<a class="reference internal image-reference" href="_images/den1_real.png"><img alt="density_result" class="align-center" src="_images/den1_real.png" style="width: 4.63529in; height: 2.97222in;" /></a>
<a class="reference internal image-reference" href="_images/den2_real.png"><img alt="density_result" class="align-center" src="_images/den2_real.png" style="width: 4.63529in; height: 3.97222in;" /></a>
<p>ECDF Plot</p>
<a class="reference internal image-reference" href="_images/ecdf_real.png"><img alt="ecdf_result" class="align-center" src="_images/ecdf_real.png" style="width: 4.63529in; height: 5.97222in;" /></a>
</section>
<section id="treatment-effect-inference">
<h2>4. Treatment Effect Inference<a class="headerlink" href="#treatment-effect-inference" title="Permalink to this heading">¬∂</a></h2>
<p>After conducting the coarsened exact matching and imbalance checking, we can estimate the <strong>average treatment effect ATT</strong> and <strong>heterogeneous treatment effect HTE</strong> with statistical inference methods.</p>
<ul class="simple">
<li><p>Ordinal least square linear regression method <code class="docutils literal notranslate"><span class="pre">linear_att</span></code> and weighted least square linear regression method <code class="docutils literal notranslate"><span class="pre">weighted_linear_att</span></code> are provided for the ATT estimation.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[Y = \hat{\theta}T + \hat{\beta}X + œµ, \widehat{ATT} = \hat{\theta}\]</div>
<ul class="simple">
<li><p>Linear double machine learning method (Chernozhukov et al. 2017) <code class="docutils literal notranslate"><span class="pre">linear_dml_hte</span></code> is provided for the HTE estimation.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}Y^{\bot X} = Y - \hat{\beta_{1}}X\\T^{\bot X} = T - \hat{\beta_{2}}X\\Y_i^{\bot X} = \widehat{\theta(X_i)}T^{\bot X} + œµ\\\widehat{HTE} = \widehat{\theta(X_i)}\\\widehat{CATE} = E{\widehat{\theta(X_i)}}\end{aligned}\end{align} \]</div>
<p><strong>Reference</strong></p>
<ul class="simple">
<li><p>Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W., &amp; Robins, J. (2017). Double/debiased machine learning for treatment and causal parameters.</p></li>
</ul>
<p>Firstly you should create your own <code class="docutils literal notranslate"><span class="pre">inference</span></code> instance, giving it your matched dataframe,  column names of result variable <span class="math notranslate nohighlight">\(re78\)</span>, treatment variable <span class="math notranslate nohighlight">\(treat\)</span>, control variables, and confounders.</p>
<p>With the weighted linear regression method and linear double machine learning method, the estimated ATT and CATE are 661.9226, 1174.266 respectively, which are much better than -635.0262.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_inf</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="c1"># matched dataframe</span>
               <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;re78&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
               <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;treat&#39;</span><span class="p">,</span> <span class="c1"># column name of treatment variable</span>
               <span class="n">col_x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;re74&#39;</span><span class="p">,</span> <span class="s1">&#39;re75&#39;</span><span class="p">],</span> <span class="c1"># list of column names of control variables, please be noted that confounders should not be included in this list</span>
               <span class="n">confounder_cols</span> <span class="o">=</span> <span class="n">my_cem</span><span class="o">.</span><span class="n">confounder_cols</span><span class="p">)</span> <span class="c1"># list of column names of confounders</span>

<span class="n">att</span> <span class="o">=</span> <span class="n">my_inf</span><span class="o">.</span><span class="n">weighted_linear_att</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;att: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">att</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">cate</span><span class="p">,</span> <span class="n">hte</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">my_inf</span><span class="o">.</span><span class="n">linear_dml_hte</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cate: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">cate</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">, r2:</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                            WLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.023
Model:                            WLS   Adj. R-squared:                  0.012
Method:                 Least Squares   F-statistic:                     2.049
Date:                Wed, 30 Aug 2023   Prob (F-statistic):              0.107
Time:                        13:04:37   Log-Likelihood:                -2830.9
No. Observations:                 271   AIC:                             5670.
Df Residuals:                     267   BIC:                             5684.
Df Model:                           3
Covariance Type:            nonrobust
==============================================================================
                coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const       5169.0557    601.703      8.591      0.000    3984.370    6353.742
treat        661.9226    817.002      0.810      0.419    -946.663    2270.508
re74          -0.0189      0.116     -0.163      0.871      -0.247       0.209
re75           0.3917      0.194      2.018      0.045       0.010       0.774
==============================================================================
Omnibus:                      204.061   Durbin-Watson:                   1.802
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             3566.896
Skew:                           2.825   Prob(JB):                         0.00
Kurtosis:                      19.851   Cond. No.                     1.21e+04
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[2] The condition number is large, 1.21e+04. This might indicate that there are
strong multicollinearity or other numerical problems.
att: 661.9226
cate: 1174.266, r2:0.0041
</pre></div>
</div>
</section>
<section id="sensitivity-analysis">
<h2>5. Sensitivity Analysis<a class="headerlink" href="#sensitivity-analysis" title="Permalink to this heading">¬∂</a></h2>
<p>When we conduct causal inference to the observational data, the most important assumption is that there is no unobserved confounding.
Therefore, after finishing the treatment effect estimation, investigators are advised to examine how strong the effect of unobserved confounders should be to erase the treatment effect estimated.</p>
</section>
<section id="omitted-variable-bias-based-sensitivity-analysis">
<h2>5.1 Omitted variable bias based sensitivity analysis<a class="headerlink" href="#omitted-variable-bias-based-sensitivity-analysis" title="Permalink to this heading">¬∂</a></h2>
<p>In the following example, we choose <span class="math notranslate nohighlight">\(educ\)</span> as our benchmark variable. The analysis result gives us the following informations:</p>
<ul class="simple">
<li><p><strong>Robustness Value (RV)</strong>:</p></li>
</ul>
<p>It provides a convenient reference point to assess the overall robustness of a coefficient to unobserved confounders. If the confounder‚Äôs association to the treatment <span class="math notranslate nohighlight">\(R_{Y\sim Z|T, X}^2\)</span> and to
the outcome <span class="math notranslate nohighlight">\(R_{Z\sim T|X}^2\)</span> are both assumed to be less than the <span class="math notranslate nohighlight">\(RV\)</span>, then such confounders cannot ‚Äúexplain away‚Äù the observed effect.</p>
<ul class="simple">
<li><p><strong>Contour Line</strong>:</p></li>
</ul>
<p>The points on the same contour line has the same adjusted estimated ATT. The contour line helps us to know the value of the adjusted estimated <span class="math notranslate nohighlight">\(ATT\)</span> when <span class="math notranslate nohighlight">\(R_{Y\sim Z|T, X}^2 = a\)</span> and <span class="math notranslate nohighlight">\(R_{Z\sim T|X}^2 = b\)</span>.</p>
<ul class="simple">
<li><p><strong>Bound the strength of the hidden confounder using observed covariate</strong>:</p></li>
</ul>
<p>We can choose an observed confounder <span class="math notranslate nohighlight">\(X_j\)</span> as a benchmark, and check the adjusted estimated <span class="math notranslate nohighlight">\(ATT\)</span> when</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\frac{R_{Y\sim Z|T, X_{-j}}^2}{R_{Y\sim X_j|T, X_{-j}}^2} = K_Y\\\frac{R_{T\sim Z|X_{-j}}^2}{R_{T\sim X_j|X_{-j}}^2} = K_T\end{aligned}\end{align} \]</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">[[</span><span class="n">my_cem</span><span class="o">.</span><span class="n">col_t</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;hispan&#39;</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">,</span> <span class="s1">&#39;nodegree&#39;</span><span class="p">,</span> <span class="s1">&#39;re74&#39;</span><span class="p">,</span> <span class="s1">&#39;re75&#39;</span><span class="p">]])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">my_cem</span><span class="o">.</span><span class="n">matched_df</span><span class="p">[</span><span class="n">my_cem</span><span class="o">.</span><span class="n">col_y</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">my_ovb</span> <span class="o">=</span> <span class="n">ovb</span><span class="p">(</span><span class="n">col_t</span><span class="o">=</span><span class="s1">&#39;treat&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">bench_variable</span><span class="o">=</span><span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="n">k_t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">k_y</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>  <span class="n">measure</span> <span class="o">=</span> <span class="s1">&#39;att&#39;</span><span class="p">)</span>
<span class="n">my_ovb</span><span class="o">.</span><span class="n">plot_result</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/ovb_real.png"><img alt="smd_result" class="align-center" src="_images/ovb_real.png" style="width: 3.03529in; height: 2.97222in;" /></a>
</section>
<section id="wilcoxon-s-signed-rank-test-based-sensitivity-analysis">
<h2>5.2 Wilcoxon‚Äôs signed rank test based sensitivity analysis<a class="headerlink" href="#wilcoxon-s-signed-rank-test-based-sensitivity-analysis" title="Permalink to this heading">¬∂</a></h2>
<p>Wilcoxon‚Äôs signed rank test based sensitivity analysis is suitable for 1-1 matched dataset, therefore 1-1 matching needs to be conducted firstly. You can implement it simply by setting <code class="docutils literal notranslate"><span class="pre">k2k_ratio</span> <span class="pre">=</span> <span class="pre">1</span></code>, and here we choose the propensity score to measure the similarity by setting <code class="docutils literal notranslate"><span class="pre">dist</span> <span class="pre">=</span> <span class="pre">'psm'</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">wilcoxon</span></code> class function can give you a result table, which shows you the p-value intervals under each <span class="math notranslate nohighlight">\(\Gamma\)</span>.</p>
<p>In the following example, when <span class="math notranslate nohighlight">\(\Gamma = 3.00\)</span>, the upper bound of the p-value‚Äôs interval is greater than 0.05, which means that in this situation, we don‚Äôt have 95% confidence to reject the null hypothesis that the treatment is randomly assigned. In other words, when <span class="math notranslate nohighlight">\(\Gamma = 3.00\)</span> the estimated ATT will be explained away by unovserved confounders.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_cem_k2k</span> <span class="o">=</span> <span class="n">cem</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">confounder_cols</span><span class="p">,</span> <span class="n">cont_confounder_cols</span><span class="p">,</span> <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;re78&#39;</span><span class="p">,</span> <span class="c1"># column name of result variable</span>
            <span class="n">col_t</span> <span class="o">=</span> <span class="s1">&#39;treat&#39;</span><span class="p">)</span>
<span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k2k_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;psm&#39;</span><span class="p">)</span>

<span class="n">my_sen</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">matched_df</span><span class="p">,</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">my_cem_k2k</span><span class="o">.</span><span class="n">pair</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;re78&#39;</span><span class="p">)</span>
<span class="n">wilcoxon_df</span> <span class="o">=</span> <span class="n">my_sen</span><span class="o">.</span><span class="n">result</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.25</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Matching result

all  matched  propotion
0  429      117     0.2727
1  185      117     0.6324

    lower_p  upper_p
gamma
1.00       0.0   0.0000
2.00       0.0   0.0060
3.00       0.0   0.1773
4.00       0.0   0.5680
4.25       0.0   0.6562
5.00       0.0   0.8470
The estimated ATT result is not reliable if there exists an unobservable confounder which makes the magnitude of probability
that a single subject will be interfered with is 3.0 times higher than that of the other subject.
</pre></div>
</div>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="example_simu.html"
       title="previous chapter">‚Üê üîñ CEM Notebook Example - Simulated Linear Dataset</a>
  </li>
  <li class="next">
    <a href="api.html"
       title="next chapter">API Reference ‚Üí</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2023, WenyiWU.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 6.2.1 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>